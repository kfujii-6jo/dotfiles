#!/bin/bash
set -eu

normalize_window_name() {
  echo "$1" | tr '/./' '_'
}

ghq_root=$(ghq root)
selected=$(ghq list | while read -r repo; do
  [[ -d "$ghq_root/$repo/.git" ]] && echo "$repo"
done | fzf)
[[ -z "$selected" ]] && exit 0

dir="$ghq_root/$selected"
session_name=$(basename "$selected" | tr '.' '_')
window_name=$(normalize_window_name "$(git -C "$dir" branch --show-current 2>/dev/null || echo "main")")

if ! tmux has-session -t "=$session_name" 2>/dev/null; then
  tmux new-session -d -s "$session_name" -n "$window_name" -c "$dir"
fi

if [[ -n "${TMUX:-}" ]]; then
  tmux switch-client -t "=$session_name"
else
  tmux attach-session -t "=$session_name"
fi
