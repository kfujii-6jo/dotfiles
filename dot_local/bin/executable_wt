#!/bin/bash
set -eu

# ウィンドウ名を正規化（ブランチ名から特殊文字を置換）
normalize_window_name() {
  echo "$1" | tr '/./' '_'
}

# ブランチ名を検証
validate_branch_name() {
  local name="$1"
  if [[ -z "$name" ]]; then
    return 1
  fi
  if ! git check-ref-format --branch "$name" 2>/dev/null; then
    echo "Error: Invalid branch name '$name'" >&2
    return 1
  fi
  return 0
}

new_mode=false
delete_mode=false
branch_name=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -b)
      new_mode=true
      shift
      # 次の引数がオプションでなければブランチ名として取得
      if [[ $# -gt 0 && "$1" != -* ]]; then
        branch_name="$1"
        shift
      fi
      ;;
    -d) delete_mode=true; shift ;;
    *) shift ;;
  esac
done

# カレントディレクトリがgitリポジトリか確認
if ! git rev-parse --git-dir &>/dev/null; then
  echo "Error: Not a git repository" >&2
  exit 1
fi

repo_root=$(git rev-parse --show-toplevel)
repo_name=$(basename "$repo_root")
session_name=$(echo "$repo_name" | tr '.' '_')

if $delete_mode; then
  # 削除モード: メインworktree以外を選択
  # worktree listの結果をキャッシュして再利用
  worktrees=$(git worktree list --porcelain | grep '^worktree ' | sed 's/^worktree //')
  main_worktree=$(echo "$worktrees" | head -1)
  selected=$(echo "$worktrees" | grep -vF "$main_worktree" | fzf)
  [[ -z "$selected" ]] && exit 0

  branch_name=$(git -C "$selected" branch --show-current)
  window_name=$(normalize_window_name "$branch_name")

  # worktreeとブランチを削除（ファイルシステム操作を先に）
  git worktree remove "$selected"
  git branch -d "$branch_name" 2>/dev/null || echo "Warning: Branch '$branch_name' not deleted (protected, unmerged, or not found)" >&2

  # tmuxウィンドウを閉じる（最後に実行）
  tmux kill-window -t "${session_name}:${window_name}" 2>/dev/null || true

  echo "Deleted worktree: $selected"
  exit 0
fi

if $new_mode; then
  # 新規worktree作成モード
  if [[ -z "$branch_name" ]]; then
    echo -n "Branch name: "
    read -r branch_name
    [[ -z "$branch_name" ]] && exit 0
  fi

  # ブランチ名を検証
  if ! validate_branch_name "$branch_name"; then
    exit 1
  fi

  # ブランチ名の/を-に置換してディレクトリ名に使用
  dir_name=$(echo "$branch_name" | tr '/' '-')
  worktree_path="$(dirname "$repo_root")/${repo_name}-${dir_name}"

  # worktree作成のエラーハンドリング
  if ! git worktree add "$worktree_path" -b "$branch_name"; then
    echo "Error: Failed to create worktree at '$worktree_path'" >&2
    exit 1
  fi

  selected="$worktree_path"
else
  # 既存worktree選択モード
  selected=$(git worktree list --porcelain | grep '^worktree ' | sed 's/^worktree //' | fzf)
  [[ -z "$selected" ]] && exit 0
fi

# ウィンドウ名: ブランチ名
if $new_mode; then
  window_name=$(normalize_window_name "$branch_name")
else
  window_name=$(normalize_window_name "$(git -C "$selected" branch --show-current)")
fi

if tmux has-session -t "$session_name" 2>/dev/null; then
  # セッションが存在: 新しいウィンドウを追加
  tmux new-window -t "$session_name" -n "$window_name" -c "$selected"
  # tmux外からの場合はattach
  [[ -z "${TMUX:-}" ]] && tmux attach-session -t "$session_name"
else
  # セッションが存在しない: 新規作成
  tmux new-session -d -s "$session_name" -n "$window_name" -c "$selected"
  tmux attach-session -t "$session_name"
fi
