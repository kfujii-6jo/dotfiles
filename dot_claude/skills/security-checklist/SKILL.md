# セキュリティスキル

このスキルは、セキュリティのベストプラクティス、OWASP Top 10対策、一般的な脆弱性防止に関する参照用知識を提供します。

## OWASP Top 10 対策

### A01: アクセス制御の不備
- [ ] すべてのエンドポイントで認可チェックを実施
- [ ] デフォルト拒否の原則を適用
- [ ] JWTトークンの署名検証を実施
- [ ] CORS設定を適切に制限
- [ ] 機能レベルのアクセス制御を実装

```
悪い例: /api/users/{id} でIDのみチェック
良い例: /api/users/{id} でID + 権限 + リソース所有者をチェック
```

### A02: 暗号化の失敗
- [ ] パスワードはbcrypt/Argon2でハッシュ化（SHA-256は不可）
- [ ] 機密データは保存時・転送時に暗号化
- [ ] TLS 1.2以上を使用
- [ ] 暗号鍵をコードにハードコードしない
- [ ] 古い暗号アルゴリズム（MD5、SHA1、DES）を使用しない

### A03: インジェクション
- [ ] SQLはパラメータ化クエリ/プリペアドステートメントを使用
- [ ] ORMを使用し、生SQLを避ける
- [ ] コマンド実行時は入力をエスケープ
- [ ] LDAPクエリはパラメータ化
- [ ] XPathインジェクション対策

```sql
-- 悪い例
query = "SELECT * FROM users WHERE id = " + userId

-- 良い例
query = "SELECT * FROM users WHERE id = ?"
stmt.setInt(1, userId)
```

### A04: 安全でない設計
- [ ] 脅威モデリングを実施
- [ ] ビジネスロジックの悪用シナリオを検討
- [ ] レート制限を実装
- [ ] 入力の上限を設定（サイズ、数量、頻度）

### A05: セキュリティ設定のミス
- [ ] デフォルトの認証情報を変更
- [ ] 不要な機能・ポートを無効化
- [ ] エラーメッセージでスタックトレースを露出しない
- [ ] セキュリティヘッダーを設定
- [ ] ディレクトリリスティングを無効化

### A06: 脆弱で古いコンポーネント
- [ ] 依存関係を定期的に更新
- [ ] 既知の脆弱性をスキャン（npm audit, Dependabot）
- [ ] 使用していない依存関係を削除
- [ ] サポート終了のフレームワーク/ライブラリを避ける

### A07: 認証の不備
- [ ] 多要素認証（MFA）をサポート
- [ ] パスワード強度要件を実装
- [ ] ブルートフォース対策（アカウントロック、遅延）
- [ ] セッション管理を適切に実装
- [ ] ログイン試行をログに記録

### A08: ソフトウェアとデータの整合性の不備
- [ ] CI/CDパイプラインのセキュリティ確保
- [ ] 依存関係の整合性検証（lockファイル）
- [ ] コード署名を実施
- [ ] 安全でないデシリアライゼーションを避ける

### A09: セキュリティログとモニタリングの不備
- [ ] 認証イベントをログに記録
- [ ] アクセス制御の失敗をログに記録
- [ ] ログに機密情報を含めない
- [ ] アラートを設定
- [ ] ログの改ざん防止

### A10: サーバーサイドリクエストフォージェリ（SSRF）
- [ ] 外部URLへのリクエストを制限
- [ ] 許可リスト方式でURLを検証
- [ ] 内部ネットワークへのアクセスをブロック
- [ ] リダイレクトを追跡しない

## 入力検証チェックリスト

### 一般原則
| チェック項目 | 説明 |
|-------------|------|
| ホワイトリスト検証 | 許可された値のみ受け入れる |
| 型検証 | 期待する型かチェック |
| 長さ制限 | 最大長を設定 |
| 範囲チェック | 数値の上下限を設定 |
| 形式検証 | 正規表現で形式をチェック |
| エンコーディング | UTF-8を正規化 |

### 出力エスケープ
| コンテキスト | エスケープ方法 |
|-------------|---------------|
| HTML本文 | HTMLエンティティエスケープ |
| HTML属性 | 属性エンコーディング |
| JavaScript | JavaScriptエスケープ |
| CSS | CSSエスケープ |
| URL | URLエンコーディング |
| SQL | パラメータ化クエリ |

## 認証・認可パターン

### セッション管理
```
- セッションIDは暗号学的に安全な乱数で生成
- セッションIDは十分な長さ（128ビット以上）
- ログイン成功後にセッションIDを再生成
- セッションタイムアウトを設定
- ログアウト時にサーバー側でセッション破棄
```

### JWT設計
```
- 適切なアルゴリズム（RS256推奨、HS256なら秘密鍵は十分な長さ）
- 有効期限（exp）を設定
- 発行者（iss）と受信者（aud）を検証
- 機密情報をペイロードに含めない
- リフレッシュトークンは安全に保存
```

### パスワードポリシー
```
最小要件:
- 長さ: 12文字以上
- 複雑さ: 大文字、小文字、数字、記号のうち3種類以上
- 漏洩パスワードリストとの照合（Have I Been Pwned API）
- パスワード履歴の保持（直近5件は再利用不可）
```

## セキュリティヘッダー

```
Content-Security-Policy: default-src 'self'; script-src 'self'
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Strict-Transport-Security: max-age=31536000; includeSubDomains
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), camera=(), microphone=()
```

## シークレット管理

### やるべきこと
- 環境変数または専用のシークレット管理サービスを使用
- シークレットをローテーション可能な設計
- 最小権限の原則を適用
- アクセスログを記録

### やってはいけないこと
- コードにシークレットをハードコード
- gitリポジトリにシークレットをコミット
- ログにシークレットを出力
- エラーメッセージでシークレットを露出

### .gitignore必須項目
```
.env
.env.*
*.pem
*.key
credentials.json
secrets.yaml
```

## 脆弱性スキャンツール

| ツール | 用途 |
|--------|------|
| npm audit / yarn audit | Node.js依存関係 |
| Dependabot | GitHub依存関係 |
| Snyk | マルチ言語依存関係 |
| OWASP ZAP | Webアプリ動的スキャン |
| SonarQube | 静的コード解析 |
| Trivy | コンテナイメージスキャン |
